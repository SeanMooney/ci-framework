---
- hosts: all
  tasks:
    - name: Run dstat
      become: true
      block:
        - name: Install dstat
          ansible.builtin.package:
            name:
              - dstat
              - sysstat
            state: present

        - name: Running dstat
          ansible.builtin.shell: >-
              dstat
              -tcmndrylpg
              --nocolor
              --output {{ ansible_user_dir }}/zuul-output/logs/dstat-csv.log
              1
              >> {{ ansible_user_dir }}/zuul-output/logs/dstat.log &
          changed_when: false

        - name: Running iostat
          ansible.builtin.shell: >-
              iostat -x -k -d -t 4 >> {{ ansible_user_dir }}/zuul-output/logs/iostat.log &
          changed_when: false
